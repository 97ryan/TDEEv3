<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Adaptive TDEE</title>

<!-- iOS look & A2HS -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAABGdBTUEAALGPC/xhBQAAABl0RVh0Q3JlYXRpb24gVGltZQAwOS8yMC8yNVgF1H4AAABqSURBVHhe7dQxAQAwDMCw/58yS0kWgOCp8y0AAAB8gWwq6J8DAACgABwAAIADHAAAQAIcAABAAhwAAEACHAAAgAMcAABAAhwAAEACHAAAgAMcAABAAhwAAEACHAAAgAMcAABAAhwAAEACHAAAgAN9gQF9m5b1x2yQAAAAASUVORK5CYII=">

<style>
  :root{
    --bg: #0b0b0b;
    --fg: #0f1115;
    --card: rgba(255,255,255,0.82);
    --card-dark: rgba(22,22,24,0.72);
    --text: #0a0a0a;
    --text-dark: #f5f7fa;
    --accent: #0a84ff; /* iOS blue */
    --red: #ff453a;
    --yellow: #ffd60a;
    --green: #30d158;
    --muted: #6b7280;
    --ring: rgba(10,132,255,0.35);
    --shadow: 0 10px 30px -10px rgba(0,0,0,0.35);
    --radius: 18px;
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg: #000;
      --fg: #0a0a0a;
      --card: var(--card-dark);
      --text: var(--text-dark);
      --shadow: 0 14px 34px -12px rgba(0,0,0,0.6);
    }
  }
  * { box-sizing: border-box; }
  html, body { height: 100%; }
  body{
    margin:0;
    font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text","SF Pro Display","Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background: radial-gradient(1200px 800px at 100% -20%, #1f2a44 0%, #0b0b0b 40%), var(--bg);
    color: var(--text);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }
  .shell{
    max-width: 1120px; margin: 0 auto; padding: env(safe-area-inset-top) 16px 40px; position: relative;
  }
  header{
    display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 0 8px;
    position: sticky; top: 0; backdrop-filter: saturate(180%) blur(18px);
    z-index:10;
  }
  .brand{
    font-weight: 800; letter-spacing:-0.02em; font-size: clamp(20px, 4vw, 28px);
    background: linear-gradient(180deg,#fff,#dfe7ff 60%,#c7d2fe);
    -webkit-background-clip: text; background-clip:text; color: transparent;
  }
  nav{ display:flex; flex-wrap:wrap; gap:6px; }
  .tab{
    appearance:none; border:0; padding:8px 12px; border-radius: 13px;
    background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(240,240,245,0.8));
    color:#111; box-shadow: var(--shadow);
  }
  .tab[aria-selected="true"]{ background: var(--accent); color:white; }
  .card{
    background: var(--card); border-radius: var(--radius); box-shadow: var(--shadow);
    backdrop-filter: saturate(150%) blur(18px); padding:14px;
  }
  .section { margin-top: 10px; display: grid; gap: 12px; }
  .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .label{ font-size:12px; color: var(--muted); margin-bottom:6px; }
  .input, .select, .button{
    width:100%; padding:12px 13px; border-radius: 14px; border:1px solid rgba(0,0,0,0.08);
    background: rgba(255,255,255,0.85); color:#0b0b0b; outline: none;
  }
  .input:focus, .select:focus{
    border-color: var(--accent); box-shadow: 0 0 0 4px var(--ring);
  }
  .button{
    background: linear-gradient(180deg, #ffffff, #f1f5ff);
    font-weight: 600;
  }
  .button.primary{
    background: linear-gradient(180deg, #3691ff, #0a84ff);
    color: white; border-color: rgba(10,132,255,0.5);
  }
  .button.ghost{ background: rgba(255,255,255,0.6); }
  .kpi{
    display:grid; grid-template-columns: repeat(2,minmax(0,1fr)); gap:12px;
  }
  .kpi .cell{ padding:12px; border-radius: 14px; background: rgba(255,255,255,0.7); }
  .kpi .title{ font-size:12px; color: var(--muted); }
  .kpi .value{ font-weight:800; font-size: 22px; margin-top: 2px; }
  .warn{ color: var(--yellow); font-size: 12px; }
  .danger{ color: var(--red); font-size: 12px; }
  .ok{ color: var(--green); font-size: 12px; }
  .conf{ display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius: 999px; color:white; font-weight:700; }
  .conf.low{ background: #ff3b30; } .conf.med{ background:#ff9f0a; } .conf.high{ background:#30d158; }
  .subtle{ color: var(--muted); font-size: 12px; }

  .toolbar{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
  .chip{ padding:6px 10px; border-radius: 12px; background: rgba(255,255,255,0.7); font-size:12px; }
  .chips{ display:flex; flex-wrap:wrap; gap:8px; }

  .range button{ border-radius:12px; padding:8px 10px; border:0; background: rgba(255,255,255,0.78); }
  .range button.active{ background: var(--accent); color:white; }

  canvas{ width:100%; height: 360px; display:block; border-radius: 16px; background: rgba(255,255,255,0.65); }

  table{ width:100%; border-collapse: collapse; font-size: 13px; }
  th, td{ padding:10px; border-bottom: 1px solid rgba(0,0,0,0.08); }
  th{ text-align:left; color: var(--muted); }

  .overlay{ position: fixed; inset:0; background: rgba(0,0,0,0.5); backdrop-filter: blur(10px); display:flex; align-items:center; justify-content:center; padding:16px; z-index: 50; }
  .hidden{ display:none !important; }

  .pill{ padding:6px 10px; border-radius: 999px; background: rgba(255,255,255,0.7); font-size: 11px; }
  .flex{ display:flex; gap:8px; align-items:center; }
  .center{ display:flex; align-items:center; justify-content:center; }
  .right{ text-align:right; }
  .sep{ height:1px; background: rgba(0,0,0,0.07); margin: 6px 0; }
  .small{ font-size: 12px; }
</style>
</head>
<body>
<div class="shell">

  <header>
    <div class="brand">Adaptive TDEE</div>
    <nav id="tabs">
      <button class="tab" data-tab="daily" aria-selected="true">Daily</button>
      <button class="tab" data-tab="graph">Graph</button>
      <button class="tab" data-tab="table">Table</button>
      <button class="tab" data-tab="import">Import/Export</button>
      <button class="tab" data-tab="settings">Settings</button>
      <button class="tab" data-tab="help">Help</button>
    </nav>
  </header>

  <div id="confRow" class="toolbar" style="margin:8px 0;">
    <div id="confBadge" class="conf low">Estimation confidence: Low</div>
    <div class="subtle" id="windowMeta"></div>
  </div>

  <!-- DAILY -->
  <section id="page-daily" class="section">
    <div class="toolbar">
      <button id="prevDay" class="button">◀</button>
      <div class="subtle">Swipe left/right to change day</div>
      <button id="nextDay" class="button">▶</button>
    </div>

    <div class="card" id="dailyCard">
      <div class="toolbar">
        <div style="font-weight:800; font-size:18px" id="dateLabel"></div>
        <div id="lastAction" class="subtle"></div>
      </div>
      <div class="row">
        <div>
          <div class="label">Weight (<span id="unitLabel">kg</span>)</div>
          <input id="inWeight" class="input" inputmode="decimal" placeholder="e.g., 70.2" />
        </div>
        <div>
          <div class="label">Calories (kcal)</div>
          <input id="inCalories" class="input" inputmode="numeric" placeholder="e.g., 2350" />
        </div>
        <div style="grid-column: 1 / -1;">
          <div class="label">Note</div>
          <input id="inNote" class="input" placeholder="optional" />
        </div>
      </div>
      <div class="sep"></div>
      <div class="kpi">
        <div class="cell"><div class="title">Need to eat</div><div class="value" id="kNeed">— kcal</div></div>
        <div class="cell"><div class="title">TDEE</div><div class="value" id="kTDEE">— kcal</div></div>
        <div class="cell"><div class="title">Calorie change needed</div><div class="value" id="kDelta">— kcal/day</div></div>
        <div class="cell"><div class="title">Current weight change</div><div class="value" id="kChange">—</div></div>
      </div>
      <div class="sep"></div>
      <div class="flex">
        <button id="btnSave" class="button primary">Save</button>
        <button id="btnUndo" class="button">Undo last</button>
        <button id="btnDelete" class="button ghost">Delete entry</button>
      </div>
      <div class="small" id="gateMsg"></div>
    </div>
  </section>

  <!-- GRAPH -->
  <section id="page-graph" class="section hidden">
    <div class="card">
      <div class="toolbar" style="margin-bottom:8px">
        <div class="chips range">
          <button data-range="1m">1M</button>
          <button data-range="3m" class="active">3M</button>
          <button data-range="6m">6M</button>
          <button data-range="1y">1Y</button>
          <button data-range="all">All</button>
        </div>
        <div class="chips">
          <label class="chip"><input type="checkbox" id="showWeight" checked> Weight</label>
          <label class="chip"><input type="checkbox" id="showCalories" checked> Calories</label>
          <label class="chip"><input type="checkbox" id="showTrend" checked> Trend</label>
          <label class="chip"><input type="checkbox" id="showCalMA" checked> Calories 7d MA</label>
        </div>
      </div>
      <canvas id="chart" width="1100" height="360"></canvas>
      <div class="subtle">Left axis: Weight (<span id="axisUnit">kg</span>) · Right axis: kcal</div>
    </div>
  </section>

  <!-- TABLE -->
  <section id="page-table" class="section hidden">
    <div class="card">
      <div class="toolbar">
        <div style="font-weight: 700;">Entries</div>
        <button id="btnDeleteSelected" class="button">Delete selected</button>
      </div>
      <div class="sep"></div>
      <div style="overflow:auto;">
        <table id="table">
          <thead>
            <tr>
              <th><input type="checkbox" id="chkAll"></th>
              <th data-sort="date">DATE</th>
              <th data-sort="weightKg">WEIGHT (kg)</th>
              <th data-sort="calories">CALORIES</th>
              <th>Δ FROM NEED</th>
              <th>NOTE</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- IMPORT/EXPORT -->
  <section id="page-import" class="section hidden">
    <div class="card">
      <div class="row">
        <div>
          <div class="label">Import CSV (date, weightKg, calories)</div>
          <input type="file" id="fileCSV" class="input" accept=".csv,text/csv" />
          <label class="chip"><input type="checkbox" id="chkCSVlbs"> Imported weights are in lbs</label>
        </div>
        <div>
          <div class="label">Status</div>
          <div id="importStatus" class="pill">—</div>
        </div>
      </div>
      <div class="sep"></div>
      <div class="flex">
        <button id="btnExportCSV" class="button">Export CSV</button>
        <button id="btnExportJSON" class="button">Export JSON</button>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="page-settings" class="section hidden">
    <div class="card">
      <div class="row">
        <div>
          <div class="label">Goal: target weekly change (kg/wk)</div>
          <input type="range" min="-1" max="1" step="0.05" id="sTarget" />
          <div class="small">Current: <span id="sTargetVal">0.00</span> kg/wk</div>
        </div>
        <div>
          <div class="label">Units</div>
          <select id="sUnit" class="select">
            <option value="metric">Metric (kg, kcal)</option>
            <option value="imperial">Imperial (lb, kcal)</option>
          </select>
        </div>
      </div>

      <div class="row">
        <div>
          <div class="label">Regression window (days)</div>
          <input id="sReg" class="input" type="number" min="21" max="84" />
        </div>
        <div>
          <div class="label">Calorie average window (days)</div>
          <input id="sCalWin" class="input" type="number" min="14" max="84" />
        </div>
      </div>

      <div class="row">
        <div>
          <div class="label">Day rollover hour (0–23)</div>
          <input id="sRollover" class="input" type="number" min="0" max="23" />
        </div>
        <div>
          <div class="label">Outlier trim (%)</div>
          <input id="sTrim" class="input" type="number" min="0" max="5" />
        </div>
      </div>

      <div class="row">
        <label class="chip"><input type="checkbox" id="sAvgDaily"> Average multiple weights/day</label>
        <div></div>
      </div>

      <div class="row">
        <label class="chip"><input type="checkbox" id="sShowBand"> Show confidence band (UI only)</label>
        <div>
          <div class="label">Default graph range</div>
          <select id="sRange" class="select">
            <option value="1m">1 mo</option>
            <option value="3m">3 mo</option>
            <option value="6m">6 mo</option>
            <option value="1y">1 y</option>
            <option value="all">All</option>
          </select>
        </div>
      </div>

      <div class="sep"></div>
      <div class="row">
        <div>
          <div class="label">Passcode (4–8 digits)</div>
          <input id="sPIN" class="input" placeholder="optional" inputmode="numeric" />
        </div>
        <div class="center">
          <button id="btnReset" class="button">Reset all data</button>
        </div>
      </div>
    </div>
  </section>

  <!-- HELP -->
  <section id="page-help" class="section hidden">
    <div class="card">
      <div style="font-weight:800; font-size:18px; margin-bottom:8px">Help & FAQ</div>
      <div class="small" style="line-height:1.5">
        <p><b>How do I use the app?</b> Enter daily weight (kg) and calories (kcal). The app uses OLS on your weight trend + your average calories to estimate your Adaptive TDEE.</p>
        <p><b>How long until it’s accurate?</b> Collect at least 3 weeks (≥21 days) of weights. More data → higher confidence.</p>
        <p><b>Formulas</b><br>
          slopeKgPerDay = regression slope; currentWeightChangeKgPerWeek = slope×7.<br>
          avgCalories = mean over calorie window.<br>
          deltaKcalPerDay = slope×7,700; TDEE = avgCalories − deltaKcalPerDay.<br>
          needToEat = TDEE + (targetWeeklyChangeKg/7×7,700).<br>
          calorieChangeNeeded = needToEat − avgCalories.
        </p>
        <p><b>Missing data?</b> Works with partial inputs. With missing calories, TDEE is unknown but weight trend still shows.</p>
        <p><b>Privacy</b> All data stays on your device. Imports are processed locally. Exports leave only when you share/save.</p>
      </div>
    </div>
  </section>

</div>

<!-- Onboarding -->
<div id="ob" class="overlay hidden">
  <div class="card" style="max-width:520px">
    <div style="font-weight:800; font-size:22px; margin-bottom:6px;">Welcome to Adaptive TDEE</div>
    <p class="small">Track weight + calories → get your true TDEE and how much to eat to hit a weekly goal. Local-only. Works great as an iOS Home Screen app.</p>
    <ul class="small" style="line-height:1.5">
      <li>Enter weight (kg) and calories (kcal). Skipping days is fine.</li>
      <li>It takes ~3+ weeks of weights for a solid estimate.</li>
      <li>Data stays on device; no accounts, no telemetry.</li>
    </ul>
    <div class="sep"></div>
    <div class="flex">
      <button id="obSample" class="button">Load sample data</button>
      <button id="obStart" class="button primary">Start</button>
    </div>
    <div class="small subtle" style="margin-top:6px;">Tip: Share → “Add to Home Screen”.</div>
  </div>
</div>

<!-- Passcode gate -->
<div id="gate" class="overlay hidden">
  <div class="card" style="max-width:360px">
    <div style="font-weight:800; font-size:18px">Enter passcode</div>
    <input id="gatePIN" class="input" type="password" inputmode="numeric" placeholder="PIN" />
    <div class="flex" style="margin-top:8px;">
      <button id="btnUnlock" class="button primary">Unlock</button>
    </div>
  </div>
</div>

<script>
/*** Utilities ***/
const clamp = (v,min,max)=>Math.min(max,Math.max(min,v));
const kgToLb = kg => kg * 2.2046226218;
const lbToKg = lb => lb / 2.2046226218;
const toISO = d => new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())).toISOString().slice(0,10);
function todayISO(rolloverHour){
  const now = new Date();
  const local = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), now.getMinutes());
  if (local.getHours() < rolloverHour){
    const y = new Date(local.getTime() - 86400000);
    return toISO(y);
  }
  return toISO(local);
}
function fmtKcal(v){ return v==null ? "— kcal" : Math.round(v).toLocaleString()+" kcal"; }
function fmtDeltaKgPerWeek(v, unit){
  if (v==null) return "—";
  const sign = v>=0 ? "+" : "";
  return unit==="metric"
    ? sign + v.toFixed(3) + " kg/wk"
    : sign + kgToLb(v).toFixed(2) + " lb/wk";
}
function mean(arr){ return arr.length? arr.reduce((a,b)=>a+b,0)/arr.length : null; }
function stdev(arr){
  if (arr.length<2) return 0;
  const m=mean(arr); let s=0; arr.forEach(v=>s+=(v-m)*(v-m)); return Math.sqrt(s/(arr.length-1));
}
function movingAverage(series, window){
  const out=[]; for(let i=0;i<series.length;i++){ const start=Math.max(0,i-window+1);
    const slice=series.slice(start,i+1).map(d=>d.value); out.push({date:series[i].date, value: mean(slice)});
  } return out;
}
function trimBounds(values, pct){
  if (pct<=0 || values.length===0) return {lo:-Infinity, hi:Infinity};
  const sorted=[...values].sort((a,b)=>a-b);
  const k=Math.floor(sorted.length*(pct/100));
  return { lo: sorted[k], hi: sorted[sorted.length-k-1] };
}

/*** Storage (localStorage JSON) ***/
const KEY="adaptive_tdee_singlefile_v1";
const Defaults = {
  settings:{
    targetWeeklyChangeKg: 0.0,
    regressionWindowDays: 49,
    calorieAvgWindowDays: 49,
    unitSystem: "metric",
    dayRollOverHour: 4,
    outlierTrimPct: 0,
    averageDailyWeights: false,
    showCalMA: true,
    showBand: false,
    defaultRange: "3m",
    passcode: null
  },
  entries:{} // date -> {weightKg?, calories?, note?, source?}
};
function loadState(){
  try{ const raw=localStorage.getItem(KEY); if(!raw) return structuredClone(Defaults);
    const obj=JSON.parse(raw);
    return { ...structuredClone(Defaults), ...obj, settings:{...structuredClone(Defaults).settings, ...obj.settings}};
  }catch{ return structuredClone(Defaults); }
}
function saveState(){ localStorage.setItem(KEY, JSON.stringify(State)); }

/*** Global State ***/
let State = loadState();
let CurrentDate = todayISO(State.settings.dayRollOverHour);
let LastSnapshot = null; // for undo

/*** Core Calculations ***/
const KCAL_PER_KG = 7700;

function sortedDates(){
  return Object.keys(State.entries).sort();
}
function entriesArray(){
  return sortedDates().map(d=>({date:d, ...State.entries[d]}));
}
function daysAgo(dateISO, n){
  const d=new Date(dateISO+"T00:00:00"); return toISO(new Date(d.getTime()- (n*86400000)));
}
function withinDays(arr, days, key){
  if(arr.length===0) return [];
  const last = arr[arr.length-1].date;
  const startISO = daysAgo(last, days-1);
  return arr.filter(r=>r.date>=startISO && r[key]!=null);
}

function ols(points){
  const n=points.length; if(n<2) return {slope:null, intercept:null, r2:null};
  let sumX=0,sumY=0,sumXY=0,sumXX=0;
  for(const p of points){ sumX+=p.x; sumY+=p.y; sumXY+=p.x*p.y; sumXX+=p.x*p.x; }
  const denom = n*sumXX - sumX*sumX; if (denom===0) return {slope:null,intercept:null,r2:null};
  const slope = (n*sumXY - sumX*sumY)/denom;
  const intercept = (sumY - slope*sumX)/n;
  const meanY = sumY/n;
  let ssTot=0, ssRes=0;
  for(const p of points){ const yhat=slope*p.x + intercept; ssTot+=(p.y-meanY)**2; ssRes+=(p.y-yhat)**2; }
  const r2 = ssTot===0? 1 : 1 - (ssRes/ssTot);
  return {slope,intercept,r2};
}

function computeAll(){
  const S = State.settings;
  const arr = entriesArray();

  // regression window on weights
  const wWin = withinDays(arr, S.regressionWindowDays, "weightKg");
  const daysWithWeight = wWin.length;

  let slope=null, intercept=null, r2=null;
  if (daysWithWeight >= 21){
    const weights = wWin.map(r=>r.weightKg);
    const {lo,hi} = trimBounds(weights, S.outlierTrimPct);
    const pts=[]; let idx=0;
    for(const r of wWin){
      if (r.weightKg>=lo && r.weightKg<=hi){ pts.push({x: idx, y: r.weightKg}); }
      idx++;
    }
    const fit = ols(pts);
    slope = fit.slope; intercept = fit.intercept; r2 = fit.r2;
  }

  const currentWeightChangeKgPerWeek = slope==null? null : slope*7;

  // calories window
  const cWin = withinDays(arr, S.calorieAvgWindowDays, "calories");
  const daysWithCalories = cWin.length;
  const avgCalories = daysWithCalories ? mean(cWin.map(r=>r.calories)) : null;

  const deltaKcalPerDay = slope==null? null : slope*KCAL_PER_KG;
  const TDEE = (avgCalories!=null && deltaKcalPerDay!=null) ? (avgCalories - deltaKcalPerDay) : null;

  const targetDeltaPerDay = (S.targetWeeklyChangeKg / 7) * KCAL_PER_KG;
  const needToEat = TDEE!=null ? (TDEE + targetDeltaPerDay) : null;
  const calorieChangeNeeded = (needToEat!=null && avgCalories!=null) ? (needToEat - avgCalories) : null;

  const windowCoveragePct = Math.round((daysWithWeight / Math.max(1, S.regressionWindowDays))*100);

  return {
    slopeKgPerDay: slope,
    intercept,
    r2,
    currentWeightChangeKgPerWeek,
    avgCalories,
    TDEE,
    needToEat,
    calorieChangeNeeded,
    dataQuality:{
      daysWithWeight, daysWithCalories, windowCoveragePct, r2
    },
    graphPrep: { wWin, cWin } // for trend mapping
  };
}

/*** UI — Tabs ***/
const pages = {
  daily: document.getElementById("page-daily"),
  graph: document.getElementById("page-graph"),
  table: document.getElementById("page-table"),
  import: document.getElementById("page-import"),
  settings: document.getElementById("page-settings"),
  help: document.getElementById("page-help"),
};
document.querySelectorAll('#tabs .tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const t=btn.dataset.tab;
    document.querySelectorAll('#tabs .tab').forEach(b=>b.setAttribute('aria-selected', String(b===btn)));
    for (const k in pages){ pages[k].classList.toggle('hidden', k!==t); }
    if (t==="graph") drawChart();
    if (t==="table") renderTable();
  });
});

/*** UI — Daily ***/
const dateLabel = document.getElementById("dateLabel");
const inWeight = document.getElementById("inWeight");
const inCalories = document.getElementById("inCalories");
const inNote = document.getElementById("inNote");
const unitLabel = document.getElementById("unitLabel");
const lastActionEl = document.getElementById("lastAction");
const gateMsg = document.getElementById("gateMsg");

function setDate(dISO){
  CurrentDate = dISO;
  dateLabel.textContent = new Date(dISO+"T00:00:00").toDateString();
  const e = State.entries[dISO] || {};
  const unit = State.settings.unitSystem;
  inWeight.value = (e.weightKg!=null) ? (unit==="metric"? e.weightKg.toFixed(2) : kgToLb(e.weightKg).toFixed(1)) : "";
  inCalories.value = (e.calories!=null) ? String(Math.round(e.calories)) : "";
  inNote.value = e.note||"";
}
function saveEntry(){
  const unit=State.settings.unitSystem;
  const wRaw=inWeight.value.trim(); const cRaw=inCalories.value.trim();
  let weightKg = (wRaw==="") ? undefined : Number(wRaw);
  if (weightKg!=null && !isNaN(weightKg)) weightKg = (unit==="metric"? weightKg : lbToKg(weightKg));
  let calories = (cRaw==="") ? undefined : Number(cRaw);
  const note = inNote.value;

  const prev = State.entries[CurrentDate] ? {...State.entries[CurrentDate]} : null;
  LastSnapshot = { date: CurrentDate, prev };

  if (!State.entries[CurrentDate]) State.entries[CurrentDate] = { source:"manual" };
  const target = State.entries[CurrentDate];
  // Average behavior for multiple weights/day
  if (State.settings.averageDailyWeights && weightKg!=null && target.weightKg!=null){
    target.weightKg = (target.weightKg + weightKg)/2;
  } else if (weightKg!=null){ target.weightKg = weightKg; }

  if (calories!=null && !isNaN(calories)) target.calories = calories;
  if (note!==undefined) target.note = note;
  target.source = target.source || "manual";

  // Clean up undefined fields
  if (weightKg==null) delete target.weightKg;
  if (calories==null) delete target.calories;
  if (!note) delete target.note;

  // If entry becomes empty, remove it
  if (Object.keys(target).length===0) delete State.entries[CurrentDate];

  saveState(); lastAction("Saved");
  refreshAll();
}
function deleteEntry(dateISO){
  if (!State.entries[dateISO]) return;
  LastSnapshot = { date: dateISO, prev: {...State.entries[dateISO]} };
  delete State.entries[dateISO];
  saveState(); lastAction("Deleted");
  refreshAll();
}
function undoLast(){
  if (!LastSnapshot){ lastAction("Nothing to undo"); return; }
  const {date, prev} = LastSnapshot;
  if (prev) State.entries[date] = prev; else delete State.entries[date];
  saveState(); lastAction("Undid");
  refreshAll();
}
function lastAction(msg){ lastActionEl.textContent = msg; setTimeout(()=>lastActionEl.textContent="", 1200); }

document.getElementById("btnSave").addEventListener('click', saveEntry);
document.getElementById("btnDelete").addEventListener('click', ()=>{ deleteEntry(CurrentDate); });
document.getElementById("btnUndo").addEventListener('click', undoLast);

document.getElementById("prevDay").addEventListener('click', ()=>moveDay(-1));
document.getElementById("nextDay").addEventListener('click', ()=>moveDay(1));

function moveDay(delta){
  const d=new Date(CurrentDate+"T00:00:00"); d.setDate(d.getDate()+delta);
  setDate(toISO(d));
}

function swipe(container){
  let sx=null, sy=null;
  container.addEventListener('touchstart', e=>{ const t=e.touches[0]; sx=t.clientX; sy=t.clientY; }, {passive:true});
  container.addEventListener('touchend', e=>{
    if (sx==null||sy==null) return;
    const t=e.changedTouches[0]; const dx=t.clientX-sx; const dy=t.clientY-sy;
    if (Math.abs(dx)>50 && Math.abs(dy)<40){ if (dx<0) moveDay(1); else moveDay(-1); }
    sx=sy=null;
  });
}
swipe(document.getElementById("dailyCard"));

/*** Confidence badge & gating ***/
const confBadge = document.getElementById("confBadge");
const windowMeta = document.getElementById("windowMeta");

function setConfidenceBadge(q){
  const score = (q.daysWithWeight>=21?1:0) + (q.windowCoveragePct>=70?1:0) + ((q.r2??0)>=0.6?1:0);
  let cls="low", label="Low";
  if (score===2) { cls="med"; label="Medium"; }
  if (score===3) { cls="high"; label="High"; }
  confBadge.className = "conf "+cls;
  confBadge.textContent = "Estimation confidence: "+label;
}

/*** Graph (Canvas) ***/
let graphRange = State.settings.defaultRange || "3m";
const chart = document.getElementById("chart");
const ctx = chart.getContext("2d");
const chkWeight = document.getElementById("showWeight");
const chkCal = document.getElementById("showCalories");
const chkTrend = document.getElementById("showTrend");
const chkCalMA = document.getElementById("showCalMA");
const axisUnit = document.getElementById("axisUnit");

document.querySelectorAll('.range button').forEach(b=>{
  b.addEventListener('click', ()=>{
    document.querySelectorAll('.range button').forEach(x=>x.classList.remove('active'));
    b.classList.add('active'); graphRange = b.dataset.range; drawChart();
  });
});
[chkWeight,chkCal,chkTrend,chkCalMA].forEach(el=>el.addEventListener('change', drawChart));

function rangeFilter(data){
  if (graphRange==="all" || data.length===0) return data;
  const end = new Date(data[data.length-1].date + "T00:00:00");
  const backDays = graphRange==="1m"?31:graphRange==="3m"?93:graphRange==="6m"?186:365;
  const start = new Date(end.getTime() - backDays*86400000);
  return data.filter(d=> new Date(d.date+"T00:00:00") >= start);
}

function drawChart(){
  const unit = State.settings.unitSystem;
  axisUnit.textContent = unit==="metric" ? "kg" : "lb";
  const arr = entriesArray();
  const data = arr.map(r=>({
    date: r.date,
    weight: r.weightKg==null? null : (unit==="metric"? r.weightKg : kgToLb(r.weightKg)),
    calories: r.calories??null
  }));
  const filtered = rangeFilter(data);
  // Build scales
  const pad=40, W=chart.width, H=chart.height;
  ctx.clearRect(0,0,W,H);
  ctx.fillStyle = "rgba(255,255,255,0.9)";
  ctx.fillRect(0,0,W,H);

  // x scale
  const xs = filtered.map(d=>new Date(d.date+"T00:00:00").getTime());
  if (xs.length===0){ ctx.fillStyle="#666"; ctx.fillText("No data", W/2-20, H/2); return; }
  const xMin = Math.min(...xs), xMax = Math.max(...xs);
  const x = t => pad + ( (t - xMin) / Math.max(1,(xMax-xMin)) ) * (W - pad*2);

  // y scales
  const wVals = filtered.filter(d=>d.weight!=null).map(d=>d.weight);
  const cVals = filtered.filter(d=>d.calories!=null).map(d=>d.calories);
  const wyMin = Math.min(...wVals, 999999), wyMax = Math.max(...wVals, -999999);
  const cyMin = Math.min(...cVals, 999999), cyMax = Math.max(...cVals, -999999);
  const wPad = (wyMax-wyMin)||1, cPad=(cyMax-cyMin)||1;
  const yW = v => H - pad - ((v - wyMin + 0.05*wPad) / (wPad*1.1)) * (H - pad*2);
  const yC = v => H - pad - ((v - cyMin + 0.05*cPad) / (cPad*1.1)) * (H - pad*2);

  // axes
  ctx.strokeStyle="#ccd"; ctx.lineWidth=1;
  ctx.beginPath(); ctx.moveTo(pad, pad); ctx.lineTo(pad, H-pad); ctx.lineTo(W-pad, H-pad); ctx.stroke();
  ctx.fillStyle="#556";
  ctx.fillText(unit==="metric"?"Weight (kg)":"Weight (lb)", 8, 16);
  ctx.fillText("Calories (kcal)", W-120, 16);

  // grid (light)
  ctx.strokeStyle="rgba(0,0,0,0.05)";
  for(let i=0;i<5;i++){ const yy=pad + i*(H-2*pad)/4; ctx.beginPath(); ctx.moveTo(pad, yy); ctx.lineTo(W-pad, yy); ctx.stroke(); }

  // weight scatter
  if (chkWeight.checked){
    ctx.fillStyle="#0a84ff";
    filtered.forEach(d=>{
      if (d.weight==null) return;
      const px=x(new Date(d.date+"T00:00:00").getTime()), py=yW(d.weight);
      ctx.beginPath(); ctx.arc(px,py,3,0,Math.PI*2); ctx.fill();
    });
  }

  // calories line
  if (chkCal.checked){
    ctx.strokeStyle="#ff3b30"; ctx.lineWidth=1.6; ctx.beginPath();
    let started=false;
    filtered.forEach(d=>{
      if (d.calories==null) { started=false; return; }
      const px=x(new Date(d.date+"T00:00:00").getTime()), py=yC(d.calories);
      if (!started){ ctx.moveTo(px,py); started=true; } else { ctx.lineTo(px,py); }
    });
    ctx.stroke();
  }

  // calories MA
  if (chkCalMA.checked){
    const calSeries = filtered.filter(d=>d.calories!=null).map(d=>({date:d.date, value:d.calories}));
    const ma = movingAverage(calSeries, 7);
    ctx.strokeStyle="#ff9f0a"; ctx.lineWidth=1.6; ctx.beginPath();
    ma.forEach((d,i)=>{
      const px=x(new Date(d.date+"T00:00:00").getTime()), py=yC(d.value);
      if (i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
    });
    ctx.stroke();
  }

  // trend line for regression window
  if (chkTrend.checked){
    const calc = computeAll();
    if (calc.slopeKgPerDay!=null && calc.intercept!=null){
      // Draw only where we have filtered dates intersecting regression window source
      const arrAll = entriesArray();
      const regWindow = withinDays(arrAll, State.settings.regressionWindowDays, "weightKg");
      // Build index mapping against regWindow order
      const dateToIndex = new Map(regWindow.map((r,i)=>[r.date,i]));
      // Trend points for filtered dates that exist in regWindow
      const tPts = filtered
        .filter(d=>dateToIndex.has(d.date))
        .map(d=>{
          const idx = dateToIndex.get(d.date);
          const w = calc.slopeKgPerDay*idx + calc.intercept;
          return {date:d.date, weight: (State.settings.unitSystem==="metric"? w : kgToLb(w))};
        });
      if (tPts.length){
        ctx.strokeStyle="#34c759"; ctx.lineWidth=2; ctx.beginPath();
        tPts.forEach((d,i)=>{
          const px=x(new Date(d.date+"T00:00:00").getTime()), py=yW(d.weight);
          if (i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
        });
        ctx.stroke();
      }
    }
  }
}

/*** Table ***/
let tableSort = { key:"date", asc:false };
const tbody = document.querySelector("#table tbody");
const chkAll = document.getElementById("chkAll");
document.querySelectorAll('#table thead th[data-sort]').forEach(th=>{
  th.addEventListener('click', ()=>{
    const key = th.dataset.sort;
    if (tableSort.key===key) tableSort.asc=!tableSort.asc; else { tableSort.key=key; tableSort.asc=false; }
    renderTable();
  });
});
chkAll.addEventListener('change', ()=>{
  tbody.querySelectorAll('input[type=checkbox]').forEach(cb=>cb.checked = chkAll.checked);
});
document.getElementById("btnDeleteSelected").addEventListener('click', ()=>{
  const cbs = Array.from(tbody.querySelectorAll('input[type=checkbox]')).filter(cb=>cb.checked);
  if (!cbs.length) return;
  cbs.forEach(cb=>{ const d = cb.dataset.date; delete State.entries[d]; });
  saveState(); renderTable(); refreshAll();
});

function renderTable(){
  const calc = computeAll();
  const need = calc.needToEat;
  const rows = entriesArray();
  rows.sort((a,b)=>{
    const ka = tableSort.key==="date"? a.date : (tableSort.key==="weightKg" ? (a.weightKg??-Infinity) : (a.calories??-Infinity));
    const kb = tableSort.key==="date"? b.date : (tableSort.key==="weightKg" ? (b.weightKg??-Infinity) : (b.calories??-Infinity));
    if (ka<kb) return tableSort.asc? -1 : 1;
    if (ka>kb) return tableSort.asc? 1 : -1;
    return 0;
  });
  tbody.innerHTML = rows.map(r=>{
    const delta = (need!=null && r.calories!=null) ? (r.calories - need) : null;
    const cls = delta==null? "" : (delta>0? 'style="color:#ff3b30"' : 'style="color:#34c759"');
    return `<tr>
      <td><input type="checkbox" data-date="${r.date}"></td>
      <td>${r.date}</td>
      <td>${r.weightKg!=null ? r.weightKg.toFixed(2) : '—'}</td>
      <td>${r.calories!=null ? Math.round(r.calories) : '—'}</td>
      <td ${cls}>${delta!=null ? (delta>0?'+':'')+Math.round(delta) : '—'}</td>
      <td>${r.note??''}</td>
    </tr>`;
  }).join("");
}

/*** Import/Export ***/
document.getElementById("fileCSV").addEventListener('change', ev=>{
  const f=ev.target.files[0]; if (!f) return;
  const lbs = document.getElementById("chkCSVlbs").checked;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const text = String(reader.result);
      const {rows, count} = parseCSV(text, lbs);
      for(const r of rows){
        const cur = State.entries[r.date] || {};
        State.entries[r.date] = {...cur, ...r, source: "import"};
      }
      saveState();
      document.getElementById("importStatus").textContent = `Imported ${count} rows`;
      refreshAll();
    }catch(e){ document.getElementById("importStatus").textContent = "Import error"; }
  };
  reader.readAsText(f);
});

function parseCSV(text, lbs){
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
  if (lines.length<2) return {rows:[], count:0};
  const head = lines[0].split(",").map(s=>s.trim().toLowerCase());
  const di = head.findIndex(h=>h==="date");
  const wi = head.findIndex(h=>h==="weightkg"||h==="weight");
  const ci = head.findIndex(h=>h==="calories");
  if (di<0) throw new Error("No date col");
  const map = {};
  for (let i=1;i<lines.length;i++){
    const cols = splitCSVLine(lines[i]);
    const date = cols[di]?.slice(0,10); if (!date) continue;
    const e = map[date] || {date};
    if (wi>=0 && cols[wi]!=="" && !isNaN(Number(cols[wi]))){
      const w = Number(cols[wi]); e.weightKg = lbs ? lbToKg(w) : w;
    }
    if (ci>=0 && cols[ci]!=="" && !isNaN(Number(cols[ci]))){
      e.calories = Number(cols[ci]);
    }
    map[date]=e;
  }
  return { rows: Object.values(map), count: Object.keys(map).length };
}
function splitCSVLine(line){
  const res=[]; let cur=""; let q=false;
  for (let i=0;i<line.length;i++){
    const ch=line[i];
    if (ch==='\"'){ q=!q; continue; }
    if (ch===',' && !q){ res.push(cur); cur=""; continue; }
    cur+=ch;
  }
  res.push(cur); return res.map(s=>s.trim());
}

document.getElementById("btnExportCSV").addEventListener('click', ()=>{
  const rows = entriesArray();
  const lines = [["date","weightKg","calories","note","source"].join(",")];
  rows.forEach(r=>lines.push([r.date, r.weightKg??"", r.calories??"", r.note??"", r.source??""].join(",")));
  const blob = new Blob([lines.join("\n")], {type:"text/csv"});
  const url = URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download="adaptive_tdee_export.csv"; a.click(); URL.revokeObjectURL(url);
});
document.getElementById("btnExportJSON").addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify({ entries: State.entries, settings: State.settings }, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob); const a=document.createElement('a');
  a.href=url; a.download="adaptive_tdee_backup.json"; a.click(); URL.revokeObjectURL(url);
});

/*** Settings ***/
const sTarget = document.getElementById("sTarget");
const sTargetVal = document.getElementById("sTargetVal");
const sUnit = document.getElementById("sUnit");
const sReg = document.getElementById("sReg");
const sCalWin = document.getElementById("sCalWin");
const sRollover = document.getElementById("sRollover");
const sTrim = document.getElementById("sTrim");
const sAvgDaily = document.getElementById("sAvgDaily");
const sShowBand = document.getElementById("sShowBand");
const sRange = document.getElementById("sRange");
const sPIN = document.getElementById("sPIN");

function bindSettings(){
  const S = State.settings;
  sTarget.value = S.targetWeeklyChangeKg;
  sTargetVal.textContent = S.targetWeeklyChangeKg.toFixed(2);
  sUnit.value = S.unitSystem;
  sReg.value = S.regressionWindowDays;
  sCalWin.value = S.calorieAvgWindowDays;
  sRollover.value = S.dayRollOverHour;
  sTrim.value = S.outlierTrimPct;
  sAvgDaily.checked = S.averageDailyWeights;
  sShowBand.checked = S.showBand;
  sRange.value = S.defaultRange;
  sPIN.value = S.passcode || "";
}

[sTarget,sUnit,sReg,sCalWin,sRollover,sTrim,sAvgDaily,sShowBand,sRange,sPIN].forEach(el=>el.addEventListener('input', ()=>{
  const S=State.settings;
  if (el===sTarget){ S.targetWeeklyChangeKg = Number(sTarget.value); sTargetVal.textContent=S.targetWeeklyChangeKg.toFixed(2); }
  if (el===sUnit){ S.unitSystem = sUnit.value; document.getElementById("unitLabel").textContent = (S.unitSystem==="metric"?"kg":"lb"); }
  if (el===sReg){ S.regressionWindowDays = clamp(Number(sReg.value),21,84); }
  if (el===sCalWin){ S.calorieAvgWindowDays = clamp(Number(sCalWin.value),14,84); }
  if (el===sRollover){ S.dayRollOverHour = clamp(Number(sRollover.value),0,23); }
  if (el===sTrim){ S.outlierTrimPct = clamp(Number(sTrim.value),0,5); }
  if (el===sAvgDaily){ S.averageDailyWeights = sAvgDaily.checked; }
  if (el===sShowBand){ S.showBand = sShowBand.checked; }
  if (el===sRange){ S.defaultRange = sRange.value; }
  if (el===sPIN){ S.passcode = sPIN.value? sPIN.value : null; }
  saveState(); refreshAll();
}));

document.getElementById("btnReset").addEventListener('click', ()=>{
  if (!confirm("Reset all local data?")) return;
  State = structuredClone(Defaults);
  saveState(); location.reload();
});

/*** Onboarding & Passcode ***/
const ob = document.getElementById("ob");
const gate = document.getElementById("gate");
document.getElementById("obStart").addEventListener('click', ()=>{ localStorage.setItem("obDone","1"); ob.classList.add("hidden"); });
document.getElementById("obSample").addEventListener('click', ()=>{
  const rows=[]; const start=new Date(); start.setDate(start.getDate()-60);
  let w=80.0;
  for(let i=0;i<60;i++){
    const d=new Date(start.getTime()+i*86400000);
    const date=toISO(d);
    const calories=2400 + Math.round((Math.sin(i/4)*100)+(Math.random()*100-50));
    w += (Math.random()*0.2-0.1);
    rows.push({date, calories, weightKg:w, source:"import"});
  }
  rows.forEach(r=> State.entries[r.date]=r);
  saveState(); localStorage.setItem("obDone","1"); ob.classList.add("hidden");
  refreshAll();
});
document.getElementById("btnUnlock").addEventListener('click', ()=>{
  const pin = document.getElementById("gatePIN").value;
  if (pin===(State.settings.passcode||"")) gate.classList.add("hidden"); else alert("Incorrect PIN");
});

/*** Render Readouts ***/
function refreshAll(){
  // set date label & inputs
  setDate(CurrentDate);

  // calculations
  const calc = computeAll();
  const unit = State.settings.unitSystem;
  document.getElementById("kNeed").textContent = fmtKcal(calc.needToEat);
  document.getElementById("kTDEE").textContent = fmtKcal(calc.TDEE);
  document.getElementById("kDelta").textContent = (calc.calorieChangeNeeded==null? "— kcal/day" : ( (calc.calorieChangeNeeded>=0?"+":"") + Math.round(calc.calorieChangeNeeded) + " kcal/day"));
  document.getElementById("kChange").textContent = fmtDeltaKgPerWeek(calc.currentWeightChangeKgPerWeek, unit);
  document.getElementById("unitLabel").textContent = unit==="metric"?"kg":"lb";

  // confidence & meta
  setConfidenceBadge(calc.dataQuality);
  windowMeta.textContent = `Regression: ${State.settings.regressionWindowDays}d · Calorie window: ${State.settings.calorieAvgWindowDays}d`;

  // gating message
  const g = (calc.dataQuality.daysWithWeight<21) ? "Collect at least 3 weeks of weight data for TDEE." : "";
  const varianceWarn = (calc.dataQuality.daysWithWeight>=21 && (calc.dataQuality.r2??0) < 0.4) ? "High day-to-day weight variance; results may take longer to stabilize." : "";
  gateMsg.innerHTML = `<span class="warn">${g}</span> ${varianceWarn?'<span class="warn"> '+varianceWarn+'</span>':''}`;

  // chart/table (if visible)
  if (!pages.graph.classList.contains('hidden')) drawChart();
  if (!pages.table.classList.contains('hidden')) renderTable();
}

/*** Init ***/
(function init(){
  // default tab is daily
  bindSettings();
  setDate(CurrentDate);
  refreshAll();

  // onboarding
  if (!localStorage.getItem("obDone")) ob.classList.remove("hidden");

  // passcode gate
  if (State.settings.passcode){ gate.classList.remove("hidden"); }

  // unit axis label
  axisUnit.textContent = State.settings.unitSystem==="metric" ? "kg" : "lb";
})();
</script>
</body>
</html>
